---
title: "Docker × pnpm × Next.js の環境構築"
excerpt: ""
coverImage:
    url: "/assets/album/DSC02455.JPG"
    alt: ""
date: "2025-03-19T02:40:00"
ogImage:
    url: "/assets/album/DSC02455.JPG"
tags:
    - "Tech"
    - "Web"
---

こちらのブログを立てたとき、書いてある手順通りにやっただけだといまいち何をしているかよくわからなかったので、今回は手順を順番に調べながら、かつちょっと前の手順とはずらしながら環境構築とサイトの公開をしてみます。

https://yasuworks.com/posts/first-post

ペンギンってなんとなく自立のイメージがありますよね。

## 方針

今回は以下の点をおさえてやってみます。

- DockerでNodeの実行環境を立てて、コンテナ内でセットアップする
- 推奨されているらしいpnpmを使ってみる

## 環境構築

まずNodeとpnpmを動かせるDockerコンテナを作ります。シンプルにこんな感じ。

```Dockerfile:Dockerfile
FROM node:22-slim AS base
WORKDIR /app
RUN yarn global add pnpm
```

```yaml:compose.yaml
services:
  app:
    build:
      context: .
    volumes:
      - .:/app
    working_dir: /app
```

最初は pnpm 公式の手順に則って、corepackを使って色々試してみていたのですが、調べるとcorepackは非推奨になったらしく、なんとなく避けて yarn で直接追加してます。

https://pnpm.io/ja/docker

Dockerの書き方についてはまだ無駄がありそうですが、一生ここで止まってしまいそうなので、Dockerについてはいずれしっかり勉強しようと思います。理解して使いこなせたらかなり気持ちよさそう。

続いて、Docker内の pnpm で下記コマンドを実行して、Nextの環境構築を行います。

```bash
docker compose run --rm app pnpm create next-app@latest tmp && mv tmp/* . && mv tmp/.* . && rm -r tmp
```

一時的にtmpディレクトリ内に展開してからファイルを移動しているのは、下記のコンフリクトエラー対策になります。例えば、


```bash
docker compose run --rm app pnpm create next-app@latest .
```

このようにカレントディレクトリをそのまま指定すると、


```bash
The directory app contains files that could conflict:

  Dockerfile
  compose.yaml

Either try using a new directory name, or remove the files listed above.
```

こんな感じでエラーになります。
(ディレクトリ内にファイルがあるとダメみたいです。この場合はDocker系のファイル。)

また、`.pnpm-store`ディレクトリがルートに作成されるので、コミット前にgitignoreに追加しておきます。

```:.gitignore
.pnpm-store
```

諸々完了後、コンテナで`pnpm dev`を実行して、任意のポートに公開されたlocalhost上でNextの初期画面が表示されれば無事環境構築完了です。やったね。

以降は公開するまでの過程でひっかかったところをメモしておきます。

## Firebase Hosting に複数サイトがある場合の設定

同じプロジェクト内に複数サイトを持つ形でサイトを増やしたので、Firebase CLI の `firebase init`そのままだとメインのサイト？にデプロイされてしまうようでした。
複数サイトある場合は構成ファイルにサイトを指定して上げる必要があります。

```diff:firebase.json
{
  "hosting": {
    "public": "out",
+    "site": "SITE_ID",
    "ignore": ["firebase.json", "**/.*", "**/node_modules/**"]
  }
}
```

## GitHub Actions の修正

pnpm のビルド用のコマンドを追加しても、そのままだと動かないらしいので、`@pnpm/action-setup`を追加します。

https://github.com/pnpm/action-setup?tab=readme-ov-file#use-cache-to-reduce-installation-time

```diff:firebase-hosting-merge.yml
# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - main
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
+      - uses: pnpm/action-setup@v4
+        with:
+          version: 9.7.0
+          run_install: false
+      - uses: actions/setup-node@v4
+        with:
+          node-version: 22
+          cache: "pnpm"
      - run: pnpm install --frozen-lockfile && pnpm run build
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_MY_PORTFOLIO_C7FB6 }}
          channelId: live
          projectId: my-portfolio-c7fb6
```

実行時間がだいぶ短縮されている気がしますね。

## 感想

いまのところpnpmの旨味を理解するところまでできていないですが、ほどほどにモダンくらいの環境が３割くらいの自力で構築できて一旦満足しております。ブログを定期的に更新できていることも嬉しい。

Dockerにはだんだん親しんできたような、まだまだ使いこなすには先が遠いような…。確実に前進している実感はあります。内容的に勉強ノート的な側面が強く、ファクトチェックも甘々なので、いつか自分で見返したときに、な〜に言ってるだコイツは、となりそうでこわいですね。

